# Moduł 1: Zarządzanie Nieruchomościami (Properties)

## Cel modułu
Umożliwienie zarządzania nieruchomościami, w tym dodawania, edycji, przeglądania i usuwania.

## Podstawowe informacje na temat nieruchomości
*   Nazwa
*   Adres (jedno textarea)
*   Powierzchnia
*   Liczba pokoi
*   Opis (textarea)
*   Status (wolne, wynajęte, niedostępne)
*   Właściciel (opisany poniżej)
*   **Informacje o spółdzielni/wspólnocie mieszkaniowej** (opcjonalne pole tekstowe)


## Właściciel
Właściciel nieruchomości nie jest jednym z użytkowników z modelu Users. Poninien mieć osobny model Owner i system zarządzania podobny do panelu z użytkonikami. Właściciel powoinien być opisany conajmniej nastepującymi informacjami:
*   Imię i nazwisko
*   Email
*   Telefon
*   Adres
*   uwagi

## Galeria zdjęć ✅ ZAIMPLEMENTOWANE

Do nieruchomości jest możliwość dodania dowolnej ilości zdjęć. Każde zdjęcie jest opisane następującymi informacjami:

*   **Oryginalna nazwa** - nazwa pliku przed uploadem
*   **Losowa nazwa systemowa** - unikalna nazwa wygenerowana przez system
*   **Wielkość w KB** - rozmiar pliku
*   **Czy zdjęcie jest wiodące** - jedno zdjęcie wiodące na nieruchomość
*   **Ścieżka do pliku** - lokalizacja w storage

### Funkcjonalności zaimplementowane:
*   **Panel galerii** - widoczny w szczegółach nieruchomości
*   **Layout galerii** - 1 duże zdjęcie wiodące + 3 małe dodatkowe
*   **Lightbox** - pełnoekranowy podgląd zdjęć z nawigacją
*   **Upload wielu plików** - możliwość dodania kilku zdjęć jednocześnie
*   **Zarządzanie w modalu** - dodawanie, ustawianie wiodącego, usuwanie
*   **Automatyczne ustawianie wiodącego** - pierwsze zdjęcie automatycznie staje się wiodącym
*   **Responsywny design** - adaptacyjny layout na różnych urządzeniach



## Załączniki ✅ ZAIMPLEMENTOWANE

Do nieruchomości jest możliwość dodania dowolnej ilości załączników. Każdy załącznik jest opisany następującymi informacjami:

*   **Oryginalna nazwa** - nazwa pliku przed uploadem
*   **Losowa nazwa systemowa** - unikalna nazwa wygenerowana przez system
*   **Wielkość w KB** - rozmiar pliku
*   **Opcjonalny opis załącznika** - do 500 znaków

### Funkcjonalności zaimplementowane:
*   **Karta załączników** - widoczna w szczegółach nieruchomości
*   **Tabela zamiast kafelków** - kompaktowy layout z kolumnami "Plik" i "Akcje"
*   **Pobieranie plików** - dedykowane przyciski pobierania z oryginalną nazwą
*   **Zarządzanie w modalu** - dodawanie, edycja opisów, usuwanie załączników
*   **Upload wielu plików** - możliwość dodania kilku załączników jednocześnie
*   **Ikony typów plików** - kompaktowe ikony dla popularnych formatów (PDF, DOC, IMG)
*   **Edycja opisów** - możliwość zmiany opisu bezpośrednio w modalu
*   **Responsywny design** - tabela z przewijaniem poziomym na mniejszych ekranach 


## Zdarzenia ✅ ZAIMPLEMENTOWANE

Do nieruchomości jest możliwość dodania dowolnej ilości zdarzeń. Każde zdarzenie jest opisane następującymi informacjami:

*   **Tytuł** - wymagane pole
*   **Opis** - opcjonalne pole tekstowe
*   **Data i godzina** - wymagana data, opcjonalna godzina (domyślnie 12:00)
*   **Uwagi** - opcjonalne pole tekstowe
*   **Opcjonalny załącznik** - plik do 10MB

### Funkcjonalności zaimplementowane:
*   **Karta zdarzeń** - widoczna w szczegółach nieruchomości z ostatnim zdarzeniem
*   **Timeline w modalu** - pełna linia czasu z wszystkimi zdarzeniami
*   **Zarządzanie w modalu** - dodawanie, edycja, usuwanie zdarzeń
*   **Upload załączników** - możliwość dodania pliku do zdarzenia
*   **Pobieranie załączników** - funkcjonalne pobieranie plików ze zdarzeń
*   **Domyślna data** - aktualna data ustawiana automatycznie przy dodawaniu
*   **Walidacja formularzy** - sprawdzanie wymaganych pól i formatów
*   **Sortowanie chronologiczne** - zdarzenia sortowane od najnowszych
*   **Responsywny design** - adaptacyjny layout na różnych urządzeniach
*   **Ikony i kolory** - wizualne rozróżnienie zdarzeń w timeline

## Dodatkowe funkcjonalności zaimplementowane

### System zarządzania właścicielami ✅ ZAIMPLEMENTOWANE
*   **Pełny CRUD** - tworzenie, edycja, przeglądanie, usuwanie właścicieli
*   **Dane kontaktowe** - imię, nazwisko, email, telefon, adres, uwagi
*   **Relacje z nieruchomościami** - jeden właściciel może mieć wiele nieruchomości
*   **Walidacja formularzy** - sprawdzanie poprawności danych
*   **Paginacja** - stronicowanie listy właścicieli
*   **Wyszukiwanie** - możliwość filtrowania właścicieli

### System zarządzania użytkownikami ✅ ZAIMPLEMENTOWANE
*   **System ról** - użytkownicy (user) i administratorzy (admin)
*   **Pełny CRUD** - zarządzanie użytkownikami przez administratorów
*   **Ochrona tras** - middleware zabezpieczający funkcje admin
*   **Autentykacja** - logowanie, rejestracja, resetowanie hasła
*   **Weryfikacja email** - potwierdzenie adresu email
*   **Zarządzanie profilem** - edycja własnych danych

### Optymalizacje UI/UX ✅ ZAIMPLEMENTOWANE
*   **Responsywny design** - adaptacja do wszystkich urządzeń
*   **Nowoczesne komponenty** - Tailwind CSS z Headless UI
*   **Płynne przejścia** - Inertia.js zapewnia SPA-like experience
*   **Walidacja w czasie rzeczywistym** - natychmiastowe informacje o błędach
*   **Potwierdzenia akcji** - modale potwierdzające usuwanie
*   **Ikony i wizualizacje** - Heroicons dla lepszej czytelności

### Bezpieczeństwo i wydajność ✅ ZAIMPLEMENTOWANE
*   **CSRF Protection** - automatyczna ochrona Laravel
*   **Walidacja po stronie serwera** - sprawdzanie danych w kontrolerach
*   **Upload plików** - bezpieczne przechowywanie w storage
*   **Ograniczenia rozmiaru** - maksymalne rozmiary plików
*   **Paginacja** - optymalizacja ładowania dużych list
*   **Caching** - optymalizacja wydajności Laravel



## Przegląd funkcjonalny

Moduł zarządzania opłatami cyklicznymi umożliwia definiowanie powtarzalnych opłat dla nieruchomości oraz śledzenie ich realizacji. System składa się z dwóch głównych komponentów:

1. **Szablony opłat** - definicje typów opłat z parametrami cykliczności
2. **Realizacje płatności** - konkretne wykonane transakcje oparte na szablonach

## Architektura systemu

### Główne komponenty:
- **FeeType** - szablon opłaty z definicją cykliczności
- **Payment** - konkretna wykonana płatność
- **FeeTypeService** - logika zarządzania szablonami opłat
- **PaymentService** - logika zarządzania płatnościami
- **PaymentScheduler** - generator wymaganych płatności

## Struktura danych

### Tabela: fee_types (Szablony opłat)

**Pola:**
- `id` - klucz główny
- `property_id` - relacja do nieruchomości
- `name` - nazwa opłaty (np. "Czynsz spółdzielni")
- `description` - szczegółowy opis opłaty
- `amount` - kwota opłaty (decimal 10,2)
- `frequency_type` - typ cykliczności (enum)
- `frequency_value` - wartość pomocnicza dla cykliczności (integer)
- `is_active` - czy opłata jest aktywna (boolean)
- `created_at`, `updated_at` - znaczniki czasowe

**Typy cykliczności (`frequency_type`):**
- `monthly` - co miesiąc
- `quarterly` - co N miesięcy (wartość w `frequency_value`)
- `biannual` - co pół roku (styczeń i lipiec)
- `annual` - raz w roku (styczeń)
- `specific_month` - w konkretnym miesiącu roku (numer w `frequency_value`)

**Indeksy:**
- `property_id` + `is_active` (zapytania o aktywne opłaty dla nieruchomości)

### Tabela: payments (Realizacje płatności)

**Pola:**
- `id` - klucz główny
- `property_id` - relacja do nieruchomości
- `fee_type_id` - relacja do szablonu opłaty (nullable)
- `amount` - zapłacona kwota (decimal 10,2)
- `payment_date` - data wykonania płatności
- `due_date` - termin płatności (nullable)
- `description` - opis płatności
- `payment_method` - sposób płatności (enum: bank_transfer, cash, card, other)
- `status` - status płatności (enum: completed, pending, failed)
- `reference_number` - numer referencyjny/potwierdzenia
- `notes` - dodatkowe notatki
- `created_at`, `updated_at` - znaczniki czasowe

**Indeksy:**
- `property_id` + `payment_date` (filtrowanie płatności)
- `fee_type_id` (sprawdzanie już wykonanych płatności)

## Logika biznesowa

### FeeTypeService - Zarządzanie szablonami opłat

**Główne funkcje:**

1. **Tworzenie szablonu opłaty**
   - Walidacja danych wejściowych
   - Sprawdzenie poprawności kombinacji frequency_type + frequency_value
   - Zapis do bazy danych

2. **Modyfikacja szablonu opłaty**
   - Walidacja zmian
   - Aktualizacja danych
   - Historia zmian (opcjonalnie)

3. **Dezaktywacja szablonu opłaty**
   - Ustawienie is_active = false (soft delete)
   - Zachowanie historii płatności

4. **Generowanie listy wymaganych opłat**
   - Algorytm sprawdzający które opłaty przypada w danym miesiącu
   - Weryfikacja czy opłata już została wykonana
   - Zwracanie listy nieopłaconych pozycji

### PaymentService - Zarządzanie płatnościami

**Główne funkcje:**

1. **Rejestracja pojedynczej płatności**
   - Walidacja danych płatności
   - Zapis transakcji
   - Aktualizacja statusu

2. **Masowa rejestracja płatności**
   - Pobranie listy wymaganych opłat na dany miesiąc
   - Utworzenie płatności dla każdej pozycji
   - Transakcyjność operacji

3. **Filtrowanie i wyszukiwanie płatności**
   - Filtry czasowe (od-do)
   - Filtry kwotowe (min-max)
   - Filtr typu opłaty
   - Filtr statusu
   - Paginacja wyników

4. **Statystyki płatności**
   - Sumy płatności w rozbiciu na miesiące
   - Liczba transakcji
   - Średnie wartości

### Algorytm sprawdzania cykliczności opłat

**Dla każdego typu cykliczności:**

1. **Monthly** - zawsze true (każdy miesiąc)

2. **Quarterly** - sprawdzenie czy liczba miesięcy od punktu bazowego jest podzielna przez frequency_value
   - Punkt bazowy: styczeń 2024
   - Wzór: (rok_bieżący - 2024) * 12 + (miesiąc_bieżący - 1) % frequency_value == 0

3. **Biannual** - tylko styczeń i lipiec (miesiące 1 i 7)

4. **Annual** - tylko styczeń (miesiąc 1)

5. **Specific_month** - tylko określony miesiąc (frequency_value)

### Generator wymaganych płatności

**Algorytm działania:**

1. Pobranie wszystkich aktywnych szablonów opłat dla nieruchomości
2. Dla każdego szablonu sprawdzenie czy przypada w bieżącym miesiącu
3. Weryfikacja czy płatność już została wykonana w tym miesiącu
4. Utworzenie listy nieopłaconych pozycji
5. Zwrócenie listy z kwotami i opisami

## Interfejs użytkownika - Struktura funkcjonalna

### Panel zarządzania szablonami opłat

**Funkcje:**
- Lista wszystkich zdefiniowanych szablonów opłat
- Formularz dodawania nowego szablonu
- Edycja istniejących szablonów
- Dezaktywacja szablonów
- Podgląd harmonogramu płatności (kiedy opłata będzie wymagana)

### Panel finansowy nieruchomości

**Sekcja 1: Historia płatności**
- Tabela z wykonanymi płatnościami
- Filtry: zakres dat, typ opłaty, kwota min/max, status
- Sortowanie po datach, kwotach
- Paginacja
- Export do CSV/PDF

**Sekcja 2: Aktualne wymagane płatności**
- Lista opłat wymaganych w bieżącym miesiącu
- Status każdej pozycji (opłacone/nieopłacone)
- Możliwość pojedynczej płatności
- Przycisk "Opłać wszystkie"

**Sekcja 3: Rejestracja płatności**
- Formularz dodania pojedynczej płatności
- Wybór szablonu opłaty lub płatność ad-hoc
- Pola: kwota, data, sposób płatności, numer referencyjny, notatki

**Sekcja 4: Statystyki**
- Wykres płatności w czasie
- Suma płatności w bieżącym roku
- Porównanie z poprzednim rokiem
- Rozbicie kosztów według typu opłaty

## Walidacja danych

### Szablon opłaty (FeeType)
- `name` - wymagane, string, max 255 znaków
- `amount` - wymagane, liczba ≥ 0
- `frequency_type` - wymagane, jeden z dozwolonych typów
- `frequency_value` - walidacja kontekstowa:
  - dla 'quarterly': wymagane, 1-12
  - dla 'specific_month': wymagane, 1-12
  - dla pozostałych: null

### Płatność (Payment)
- `amount` - wymagane, liczba ≥ 0
- `payment_date` - wymagane, poprawna data
- `fee_type_id` - opcjonalne, musi istnieć w bazie
- `status` - jeden z dozwolonych statusów
- `payment_method` - jeden z dozwolonych sposobów

## Bezpieczeństwo i autoryzacja

### Uprawnienia:
- **Właściciel nieruchomości** - pełny dostęp do opłat swojej nieruchomości
- **Administrator** - dostęp do wszystkich nieruchomości
- **Tylko odczyt** - dostęp do przeglądania bez możliwości zmian

### Zabezpieczenia:
- Sprawdzenie własności nieruchomości przed każdą operacją
- Walidacja uprawnień w kontrolerach i serwisach
- Logowanie wszystkich operacji finansowych
- Możliwość audytu zmian (opcjonalnie)

## Integracje i rozszerzenia

### Potencjalne integracje:
- **System bankowy** - automatyczne pobranie wyciągów
- **API płatności** - automatyczne wykonywanie płatności
- **System księgowy** - eksport danych księgowych
- **Powiadomienia** - przypomnienia o płatnościach

### Możliwe rozszerzenia:
- **Budżetowanie** - planowanie kosztów na przyszłe okresy
- **Prognozy** - przewidywanie kosztów na podstawie historii
- **Raportowanie** - zaawansowane raporty finansowe
- **Kategorie kosztów** - grupowanie opłat w kategorie
- **Waluty** - obsługa różnych walut

## Przepływ danych

### Dodawanie nowej opłaty cyklicznej:
1. Użytkownik wypełnia formularz szablonu opłaty
2. System waliduje dane
3. FeeTypeService tworzy nowy rekord
4. Generator płatności uwzględnia nową opłatę w przyszłych miesiącach

### Wykonywanie płatności miesięcznych:
1. Użytkownik wchodzi w panel finansowy
2. System generuje listę wymaganych płatności na bieżący miesiąc
3. Użytkownik wybiera "Opłać wszystkie"
4. PaymentService tworzy rekordy płatności dla wszystkich pozycji
5. System aktualizuje statusy i wyświetla potwierdzenie

### Przeglądanie historii:
1. Użytkownik ustawia filtry w panelu historii
2. System pobiera przefiltrowane dane z paginacją
3. Wyświetla tabelę z możliwością sortowania i eksportu
  



